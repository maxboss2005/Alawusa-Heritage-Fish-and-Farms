<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard | Alawusa Heritage</title>
    <link
      rel="shortcut icon"
      href="Alawusa heritage icon - Icon.png"
      type="img"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #1a4d2e;
        --secondary-color: #28a745;
        --accent-color: #ffc107;
        --light-bg: #f9f9f9;
        --dark-text: #333;
        --light-text: #fff;
        --border-radius: 8px;
        --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: #f5f7fa;
        color: #333;
        display: flex;
        min-height: 100vh;
        font-size: 14px;
      }

      /* Sidebar - Mobile First */
      .sidebar {
        width: 100%;
        background: var(--primary-color);
        color: white;
        padding: 20px 0;
        position: fixed;
        bottom: 0;
        height: 60px;
        overflow-y: auto;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }

      .logo {
        display: none;
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }

      .logo img {
        width: 180px;
        filter: brightness(2) invert(0);
      }

      .nav-menu {
        list-style: none;
        display: flex;
        justify-content: space-around;
        align-items: center;
        width: 100%;
        padding: 0 20px;
      }

      .nav-item {
        margin: 0;
      }

      .nav-link {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 10px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: var(--transition);
        border-radius: var(--border-radius);
        min-width: 60px;
      }

      .nav-link:hover,
      .nav-link.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-link i {
        width: 20px;
        text-align: center;
        font-size: 18px;
      }

      .nav-link span {
        font-size: 10px;
        text-align: center;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        padding: 20px;
        padding-bottom: 80px; /* Space for mobile sidebar */
        width: 100%;
      }

      /* Top Bar */
      .top-bar {
        background: white;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
        justify-content: space-between;
      }

      .search-bar {
        width: 100%;
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border-radius: 30px;
        padding: 10px 15px;
      }

      .search-bar input {
        flex: 1;
        border: none;
        background: none;
        outline: none;
        padding: 0 10px;
        font-size: 14px;
      }

      .admin-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }

      .admin-info > div:first-child h4 {
        font-size: 14px;
        margin-bottom: 3px;
      }

      .admin-info > div:first-child p {
        font-size: 12px;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 25px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
      }

      .stat-content h3 {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 3px;
      }

      .stat-content p {
        color: #666;
        font-size: 13px;
      }

      /* Charts */
      .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      .chart-card {
        background: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
      }

      .chart-card h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 16px;
      }

      .chart-card canvas {
        width: 100% !important;
        height: 250px !important;
      }

      /* Today's Overview Cards */
      .today-overview {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .today-metric-card {
        background: white;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border-left: 4px solid #1976d2;
      }

      .today-metric-card:nth-child(2) {
        border-left-color: #4caf50;
      }

      .today-metric-card:nth-child(3) {
        border-left-color: #ff9800;
      }

      .today-metric-card:nth-child(4) {
        border-left-color: #9c27b0;
      }

      .today-metric-card h4 {
        font-size: 20px;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
      }

      .today-metric-card p {
        margin: 5px 0 0 0;
        font-size: 12px;
        opacity: 0.8;
      }

      .today-metric-card i {
        opacity: 0.8;
        font-size: 20px;
      }

      /* Orders Table */
      .orders-card {
        background: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow-x: auto;
      }

      .table-header {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      .table-header h3 {
        color: #333;
        font-size: 16px;
      }

      .table-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .btn {
        padding: 8px 12px;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
        font-size: 14px;
        white-space: nowrap;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background: #0d3b1e;
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
      }

      .btn-secondary:hover {
        background: #e9ecef;
      }

      /* Table Responsive */
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }

      th {
        text-align: left;
        padding: 12px 10px;
        background: #f8f9fa;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #eee;
        font-size: 13px;
      }

      td {
        padding: 12px 10px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }

      tr:hover {
        background: #f9f9f9;
      }

      /* STATUS BADGES */
      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
        text-transform: capitalize;
      }

      .status-awaiting_payment {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffb74d;
      }

      .status-confirmed {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .status-processing {
        background: #cce5ff;
        color: #004085;
        border: 1px solid #b3d7ff;
      }

      .status-shipped {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-delivered {
        background: #28a745;
        color: white;
        border: 1px solid #218838;
      }

      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        font-size: 14px;
      }

      /* Modal Responsive */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 15px;
      }

      .modal-content {
        background: white;
        padding: 20px;
        border-radius: var(--border-radius);
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .modal-header h3 {
        color: #333;
        font-size: 18px;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
        font-size: 13px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-family: "Poppins", sans-serif;
        font-size: 14px;
      }

      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }

      /* Order items in modal */
      .order-items-grid {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }

      .order-item-card {
        display: grid;
        grid-template-columns: 60px 1fr;
        gap: 10px;
        padding: 12px;
        background: #f9f9f9;
        border-radius: var(--border-radius);
        border: 1px solid #eee;
      }

      .order-item-img {
        width: 100%;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
      }

      .order-item-details {
        display: grid;
        gap: 4px;
      }

      .order-item-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 3px;
        font-size: 14px;
      }

      .order-item-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        font-size: 12px;
        color: #666;
      }

      .order-item-price {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 13px;
      }

      /* Status actions responsive */
      .status-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      .status-btn {
        padding: 10px;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        font-size: 13px;
        text-align: center;
        white-space: nowrap;
      }

      /* Filter Dropdown */
      .status-filter {
        position: relative;
      }

      #statusFilterDropdown {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        margin: 0;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        width: 90%;
        max-width: 400px;
        z-index: 1001;
      }

      /* Tablet (768px and up) */
      @media (min-width: 768px) {
        body {
          font-size: 15px;
        }

        .sidebar {
          width: 70px;
          height: 100vh;
          top: 0;
          bottom: auto;
          justify-content: flex-start;
          flex-direction: column;
          box-shadow: none;
        }

        .nav-menu {
          flex-direction: column;
          gap: 10px;
          padding: 20px 0;
        }

        .nav-link {
          flex-direction: row;
          justify-content: center;
          gap: 15px;
          padding: 15px;
        }

        .nav-link span {
          display: none;
        }

        .main-content {
          margin-left: 70px;
          padding: 20px;
          padding-bottom: 20px;
        }

        .top-bar {
          flex-direction: row;
          align-items: center;
          gap: 20px;
        }

        .search-bar {
          max-width: 300px;
        }

        .admin-info {
          width: auto;
          gap: 15px;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 20px;
        }

        .charts-grid {
          grid-template-columns: 1fr;
        }

        .today-overview {
          grid-template-columns: repeat(2, 1fr);
        }

        .table-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }

        table {
          min-width: 700px;
        }

        .modal-content {
          max-width: 90%;
        }
      }

      /* Desktop (992px and up) */
      @media (min-width: 992px) {
        body {
          font-size: 16px;
        }

        .sidebar {
          width: 250px;
        }

        .logo {
          display: block;
        }

        .nav-menu {
          gap: 5px;
        }

        .nav-link {
          justify-content: flex-start;
          padding: 15px 20px;
        }

        .nav-link span {
          display: inline;
          font-size: 14px;
        }

        .main-content {
          margin-left: 250px;
        }

        .stats-grid {
          grid-template-columns: repeat(4, 1fr);
        }

        .charts-grid {
          grid-template-columns: 2fr 1fr;
        }

        .today-overview {
          grid-template-columns: 1fr;
        }

        table {
          min-width: 100%;
        }

        .modal-content {
          max-width: 800px;
        }

        .status-actions {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      /* Large Desktop (1200px and up) */
      @media (min-width: 1200px) {
        .main-content {
          padding: 30px;
        }

        .charts-grid {
          gap: 30px;
        }

        .today-overview {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* Small Mobile (480px and below) */
      @media (max-width: 480px) {
        body {
          font-size: 13px;
        }

        .main-content {
          padding: 15px;
          padding-bottom: 70px;
        }

        .top-bar {
          padding: 12px;
        }

        .stat-card {
          padding: 15px;
        }

        .stat-icon {
          width: 45px;
          height: 45px;
          font-size: 18px;
        }

        .stat-content h3 {
          font-size: 20px;
        }

        .chart-card {
          padding: 15px;
        }

        .orders-card {
          padding: 15px;
        }

        .btn {
          padding: 6px 10px;
          font-size: 12px;
        }

        .action-btn {
          width: 28px;
          height: 28px;
          font-size: 12px;
        }

        .modal-content {
          padding: 15px;
        }

        .status-actions {
          grid-template-columns: 1fr;
        }
      }

      /* Very Small Mobile (360px and below) */
      @media (max-width: 360px) {
        .nav-link {
          padding: 8px;
          min-width: 50px;
        }

        .nav-link i {
          font-size: 16px;
        }

        .nav-link span {
          font-size: 9px;
        }

        .stats-grid {
          gap: 12px;
        }

        .table-actions {
          gap: 8px;
        }

        .btn {
          padding: 5px 8px;
          font-size: 11px;
        }
      }

      /* Landscape Mode */
      @media (max-height: 600px) and (orientation: landscape) {
        .sidebar {
          height: 100vh;
        }

        .main-content {
          padding-bottom: 20px;
        }

        .modal-content {
          max-height: 80vh;
        }
      }

      /* Touch device optimizations */
      @media (hover: none) and (pointer: coarse) {
        .btn,
        .action-btn,
        .status-btn {
          min-height: 44px; /* Apple's recommended minimum touch target size */
          min-width: 44px;
        }

        .nav-link {
          min-height: 44px;
          min-width: 44px;
        }

        input,
        select,
        textarea {
          font-size: 16px; /* Prevents iOS zoom on focus */
        }
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        .status-badge {
          border-width: 2px;
        }

        .nav-link.active {
          outline: 2px solid white;
        }
      }

      /* Reduced motion */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <img src="Alawusa heritage logo.png" alt="Alawusa Heritage" />
      </div>
      <nav>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="#dashboard" class="nav-link active">
              <i class="fas fa-chart-line"></i>
              <span>Dashboard</span>
            </a>
          </li>

          <li class="nav-item" style="margin-top: 0px">
            <a href="index.html" class="nav-link">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input
            type="text"
            id="searchOrders"
            placeholder="Search by order ID, customer name"
          />
        </div>
        <div class="admin-info">
          <div>
            <h4 style="margin-bottom: 5px">Alawusa Heritage Fish and Farms</h4>
            <p style="color: #666; font-size: 14px">
              alawusaheritage@gmail.com
            </p>
          </div>
          <div
            style="
              width: 40px;
              height: 40px;
              border-radius: 50%;
              background: var(--primary-color);
              color: white;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <i class="fas fa-user"></i>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e3f2fd; color: #1976d2">
            <i class="fas fa-shopping-bag"></i>
          </div>
          <div class="stat-content">
            <h3 id="totalOrders">0</h3>
            <p>Total Orders</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: #fff3cd; color: #f57c00">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <h3 id="pendingOrders">0</h3>
            <p>Pending Orders</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: #d4edda; color: #28a745">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-content">
            <h3 id="completedOrders">0</h3>
            <p>Completed Orders</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: #ffe0b2; color: #ff9800">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="stat-content">
            <h3 id="totalRevenue">₦0</h3>
            <p>Total Revenue</p>
          </div>
        </div>
      </div>

      <!-- Add this in your top-bar or somewhere visible -->
      <div style="display: flex; align-items: center; gap: 10px">
        <button
          class="btn btn-secondary"
          onclick="updateTodaysOverview()"
          title="Refresh Today's Metrics"
        >
          <p>Refresh Today's Metrics</p>
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>

      <!-- Replace the second chart-card in charts-grid -->
      <div class="charts-grid">
        <div class="chart-card">
          <div style="padding: 20px">
            <h3 style="margin-bottom: 20px">Today's Overview</h3>
            <div style="display: grid; gap: 15px">
              <!-- Today's Orders -->
              <div
                style="
                  background: #e3f2fd;
                  padding: 15px;
                  border-radius: var(--border-radius);
                  border-left: 4px solid #1976d2;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <h4
                      style="font-size: 24px; color: #1976d2; margin: 0"
                      id="todayOrders"
                    >
                      0
                    </h4>
                    <p style="color: #666; font-size: 13px; margin: 5px 0 0 0">
                      Today's Orders
                    </p>
                  </div>
                  <i
                    class="fas fa-shopping-bag"
                    style="color: #1976d2; font-size: 24px"
                  ></i>
                </div>
              </div>

              <!-- Today's Revenue -->
              <div
                style="
                  background: #e8f5e9;
                  padding: 15px;
                  border-radius: var(--border-radius);
                  border-left: 4px solid #4caf50;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <h4
                      style="font-size: 24px; color: #4caf50; margin: 0"
                      id="todayRevenue"
                    >
                      ₦0
                    </h4>
                    <p style="color: #666; font-size: 13px; margin: 5px 0 0 0">
                      Today's Revenue
                    </p>
                  </div>
                  <i
                    class="fas fa-money-bill-wave"
                    style="color: #4caf50; font-size: 24px"
                  ></i>
                </div>
              </div>

              <!-- Avg. Order Value -->
              <div
                style="
                  background: #fff3e0;
                  padding: 15px;
                  border-radius: var(--border-radius);
                  border-left: 4px solid #ff9800;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <h4
                      style="font-size: 24px; color: #ff9800; margin: 0"
                      id="avgOrderValue"
                    >
                      ₦0
                    </h4>
                    <p style="color: #666; font-size: 13px; margin: 5px 0 0 0">
                      Avg. Order Value
                    </p>
                  </div>
                  <i
                    class="fas fa-chart-bar"
                    style="color: #ff9800; font-size: 24px"
                  ></i>
                </div>
              </div>

              <!-- Conversion Rate -->
              <div
                style="
                  background: #f3e5f5;
                  padding: 15px;
                  border-radius: var(--border-radius);
                  border-left: 4px solid #9c27b0;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <h4
                      style="font-size: 24px; color: #9c27b0; margin: 0"
                      id="completionRate"
                    >
                      0%
                    </h4>
                    <p style="color: #666; font-size: 13px; margin: 5px 0 0 0">
                      Completed Orders
                    </p>
                  </div>
                  <i
                    class="fas fa-percentage"
                    style="color: #9c27b0; font-size: 24px"
                  ></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <canvas id="salesChart"></canvas>
      </div>

      <!-- Orders Table -->
      <div class="orders-card">
        <div class="table-header">
          <h3>Recent Orders</h3>
          <div style="display: flex; gap: 15px; align-items: center">
            <div class="table-actions">
              <!-- Status Filter Dropdown -->
              <div class="status-filter" style="position: relative">
                <button
                  class="btn btn-secondary"
                  id="statusFilterBtn"
                  style="display: flex; align-items: center; gap: 8px"
                >
                  <i class="fas fa-filter"></i>
                  <span>Filter by Status</span>
                  <i class="fas fa-chevron-down" style="font-size: 12px"></i>
                </button>
                <div
                  id="statusFilterDropdown"
                  style="
                    position: absolute;
                    top: 100%;
                    left: 0;
                    margin-top: 5px;
                    background: white;
                    border-radius: var(--border-radius);
                    box-shadow: var(--box-shadow);
                    min-width: 200px;
                    display: none;
                    z-index: 1000;
                  "
                >
                  <div style="padding: 15px">
                    <h4
                      style="margin-bottom: 10px; font-size: 14px; color: #333"
                    >
                      Order Status
                    </h4>
                    <div
                      style="display: flex; flex-direction: column; gap: 8px"
                    >
                      <label
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          cursor: pointer;
                          padding: 5px 0;
                        "
                      >
                        <input
                          type="checkbox"
                          value="all"
                          class="status-checkbox"
                        />
                        <span>All Orders</span>
                      </label>
                      <label
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          cursor: pointer;
                          padding: 5px 0;
                        "
                      >
                        <input
                          type="checkbox"
                          value="awaiting_payment"
                          class="status-checkbox"
                        />
                        <span>Awaiting Payment</span>
                      </label>
                      <label
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          cursor: pointer;
                          padding: 5px 0;
                        "
                      >
                        <input
                          type="checkbox"
                          value="confirmed"
                          class="status-checkbox"
                        />
                        <span>Confirmed</span>
                      </label>
                      <label
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          cursor: pointer;
                          padding: 5px 0;
                        "
                      >
                        <input
                          type="checkbox"
                          value="processing"
                          class="status-checkbox"
                        />
                        <span>Processing</span>
                      </label>
                      <label
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          cursor: pointer;
                          padding: 5px 0;
                        "
                      >
                        <input
                          type="checkbox"
                          value="shipped"
                          class="status-checkbox"
                        />
                        <span>Shipped</span>
                      </label>
                      <label
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          cursor: pointer;
                          padding: 5px 0;
                        "
                      >
                        <input
                          type="checkbox"
                          value="delivered"
                          class="status-checkbox"
                        />
                        <span>Delivered</span>
                      </label>

                      <div
                        style="
                          display: flex;
                          gap: 8px;
                          margin-top: 15px;
                          border-top: 1px solid #eee;
                          padding-top: 15px;
                        "
                      >
                        <button
                          class="btn btn-secondary"
                          onclick="applyStatusFilter()"
                          style="flex: 1; padding: 8px"
                        >
                          Apply
                        </button>
                        <button
                          class="btn"
                          onclick="resetStatusFilter()"
                          style="
                            flex: 1;
                            padding: 8px;
                            background: #f8f9fa;
                            color: #333;
                          "
                        >
                          Reset
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <button class="btn btn-secondary" onclick="exportOrders()">
                <i class="fas fa-download"></i> Export
              </button>
              <button class="btn btn-primary" onclick="refreshOrders()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              <!-- Orders will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Order Details Modal -->
    <div id="orderModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Order Details</h3>
          <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody">
          <!-- Order details will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3>
            <i
              class="fas fa-exclamation-triangle"
              style="color: #f44336; margin-right: 10px"
            ></i>
            Confirm Deletion
          </h3>
          <button class="close-modal" onclick="closeDeleteModal()">
            &times;
          </button>
        </div>
        <div id="deleteModalBody">
          <!-- Delete confirmation content will be loaded here -->
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        orderBy,
        doc,
        getDoc,
        updateDoc,
        deleteDoc,
        where,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDuxTHLfwiETTMO6Dx7YMehngZqWLgUlH0",
        authDomain: "alawusa-heritage-website.firebaseapp.com",
        projectId: "alawusa-heritage-website",
        storageBucket: "alawusa-heritage-website.firebasestorage.app",
        messagingSenderId: "857988164081",
        appId: "1:857988164081:web:ccac1200d344a8bd82bc50",
        measurementId: "G-TJQJMVVMZG",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Global variables
      let allOrders = [];
      let pendingDeleteOrder = null;

      // Check authentication
      function checkAuth() {
        const isAuthenticated = localStorage.getItem("adminAuthenticated");
        if (!isAuthenticated || isAuthenticated !== "true") {
          window.location.href = "admin-login.html";
          return false;
        }
        return true;
      }

      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", () => {
        if (!checkAuth()) return;

        // If authenticated, load orders
        loadOrders();

        // Setup logout
        const logoutBtn = document.querySelector('a[href="index.html"]');
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            localStorage.removeItem("adminAuthenticated");
            window.location.href = "admin-login.html";
          });
        }
      });

      // Format date
      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch (error) {
          return dateString || "N/A";
        }
      }

      // Format currency
      function formatCurrency(amount) {
        return `₦${parseFloat(amount || 0).toLocaleString()}`;
      }

      // Format status badge
      function getStatusBadge(status) {
        const statusMap = {
          awaiting_payment: {
            class: "status-awaiting_payment",
            text: "Awaiting Payment",
          },
          ordered: { class: "status-confirmed", text: "Ordered" },
          confirmed: { class: "status-confirmed", text: "Confirmed" },
          processing: { class: "status-processing", text: "Processing" },
          shipped: { class: "status-shipped", text: "Shipped" },
          delivered: { class: "status-delivered", text: "Delivered" },
          cancelled: { class: "status-cancelled", text: "Cancelled" },
        };

        const statusInfo = statusMap[status] || {
          class: "status-awaiting_payment",
          text: status || "Pending",
        };
        return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
      }

      // Load orders from BOTH collections
      async function loadOrders() {
        if (!checkAuth()) return;

        console.log("Loading orders from Firebase...");

        try {
          allOrders = [];

          // 1. Load from regular orders collection (registered users)
          try {
            const ordersRef = collection(db, "orders");
            const q = query(ordersRef, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach((doc) => {
              const orderData = doc.data();
              console.log("Registered order found:", orderData.orderId);
              allOrders.push({
                firebaseId: doc.id,
                firebaseCollection: "orders",
                orderId: orderData.orderId,
                ...orderData,
                userType: "registered",
              });
            });
            console.log(`Loaded ${querySnapshot.size} registered orders`);
          } catch (registeredError) {
            console.error("Error loading registered orders:", registeredError);
          }

          // 2. Load from unregisteredOrders collection
          try {
            const unregisteredOrdersRef = collection(db, "unregisteredOrders");
            const unregisteredQ = query(
              unregisteredOrdersRef,
              orderBy("createdAt", "desc")
            );
            const unregisteredSnapshot = await getDocs(unregisteredQ);

            unregisteredSnapshot.forEach((doc) => {
              const orderData = doc.data();
              console.log("Unregistered order found:", orderData.orderId);
              allOrders.push({
                firebaseId: doc.id,
                firebaseCollection: "unregisteredOrders",
                orderId: orderData.orderId,
                ...orderData,
                userType: "unregistered",
              });
            });
            console.log(
              `Loaded ${unregisteredSnapshot.size} unregistered orders`
            );
          } catch (unregisteredError) {
            console.error(
              "Error loading unregistered orders:",
              unregisteredError
            );
          }

          // 3. Load from localStorage as backup
          try {
            const userOrders = JSON.parse(
              localStorage.getItem("userOrders") || "{}"
            );
            for (const userId in userOrders) {
              userOrders[userId].forEach((order) => {
                if (!allOrders.find((o) => o.orderId === order.orderId)) {
                  console.log("Adding localStorage order:", order.orderId);
                  allOrders.push({
                    firebaseId: order.orderId,
                    firebaseCollection: "localStorage",
                    orderId: order.orderId,
                    ...order,
                    userType: "localStorage",
                  });
                }
              });
            }
          } catch (localStorageError) {
            console.error(
              "Error loading localStorage orders:",
              localStorageError
            );
          }

          // 4. Load unregistered orders from localStorage
          try {
            const unregisteredLocalOrders = JSON.parse(
              localStorage.getItem("unregisteredOrders") || "[]"
            );
            unregisteredLocalOrders.forEach((order) => {
              if (!allOrders.find((o) => o.orderId === order.orderId)) {
                console.log(
                  "Adding unregistered localStorage order:",
                  order.orderId
                );
                allOrders.push({
                  firebaseId: order.orderId,
                  firebaseCollection: "localStorage",
                  orderId: order.orderId,
                  ...order,
                  userType: "unregistered",
                });
              }
            });
          } catch (unregisteredLocalError) {
            console.error(
              "Error loading unregistered localStorage orders:",
              unregisteredLocalError
            );
          }

          console.log(`Total orders loaded: ${allOrders.length}`);

          // Sort all orders by date (newest first)
          allOrders.sort((a, b) => {
            const dateA = new Date(a.createdAt || a.orderDate || 0);
            const dateB = new Date(b.createdAt || b.orderDate || 0);
            return dateB - dateA;
          });

          updateStats();
          renderOrdersTable(allOrders);
          updateCharts();
          updateTodaysOverview();
        } catch (error) {
          console.error("Error loading orders:", error);
          // Fallback to localStorage only
          console.log("Falling back to localStorage...");
          allOrders = [];

          try {
            const userOrders = JSON.parse(
              localStorage.getItem("userOrders") || "{}"
            );
            for (const userId in userOrders) {
              allOrders.push(
                ...userOrders[userId].map((order) => ({
                  firebaseId: order.orderId,
                  firebaseCollection: "localStorage",
                  orderId: order.orderId,
                  ...order,
                  userType: "registered",
                }))
              );
            }

            const unregisteredLocalOrders = JSON.parse(
              localStorage.getItem("unregisteredOrders") || "[]"
            );
            unregisteredLocalOrders.forEach((order) => {
              allOrders.push({
                firebaseId: order.orderId,
                firebaseCollection: "localStorage",
                orderId: order.orderId,
                ...order,
                userType: "unregistered",
              });
            });

            allOrders.sort((a, b) => {
              const dateA = new Date(a.createdAt || a.orderDate || 0);
              const dateB = new Date(b.createdAt || b.orderDate || 0);
              return dateB - dateA;
            });

            updateStats();
            filterOrdersByStatus(); // This will apply current filters
          } catch (fallbackError) {
            console.error("Fallback also failed:", fallbackError);
            showNoOrders();
          }
        }
      }

      // Status Filter Variables
      let currentStatusFilter = ["all"]; // Default shows all

      // Toggle filter dropdown
      document
        .getElementById("statusFilterBtn")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          const dropdown = document.getElementById("statusFilterDropdown");
          dropdown.style.display =
            dropdown.style.display === "block" ? "none" : "block";
        });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("statusFilterDropdown");
        const filterBtn = document.getElementById("statusFilterBtn");

        if (
          dropdown &&
          !dropdown.contains(e.target) &&
          !filterBtn.contains(e.target)
        ) {
          dropdown.style.display = "none";
        }
      });

      // Apply status filter
      function applyStatusFilter() {
        const checkboxes = document.querySelectorAll(
          ".status-checkbox:checked"
        );
        const selectedStatuses = Array.from(checkboxes).map((cb) => cb.value);

        // If "all" is selected, show all orders regardless of other selections
        if (selectedStatuses.includes("all")) {
          currentStatusFilter = ["all"];
          document
            .querySelectorAll('.status-checkbox:not([value="all"])')
            .forEach((cb) => {
              cb.checked = true;
            });
        } else {
          currentStatusFilter = selectedStatuses;
          document.querySelector(
            '.status-checkbox[value="all"]'
          ).checked = false;
        }

        // Update filter button appearance
        updateFilterButton();

        // Apply the filter
        filterOrdersByStatus();

        // Close dropdown
        document.getElementById("statusFilterDropdown").style.display = "none";
      }

      // Reset status filter
      function resetStatusFilter() {
        // Check all checkboxes including "all"
        document.querySelectorAll(".status-checkbox").forEach((cb) => {
          cb.checked = true;
        });

        currentStatusFilter = ["all"];
        updateFilterButton();
        filterOrdersByStatus();
        document.getElementById("statusFilterDropdown").style.display = "none";
      }

      // Update filter button appearance
      function updateFilterButton() {
        const filterBtn = document.getElementById("statusFilterBtn");
        const filterContainer = filterBtn.closest(".status-filter");
        const badge =
          filterBtn.querySelector(".badge") || document.createElement("span");

        if (!filterBtn.querySelector(".badge")) {
          badge.className = "badge";
          filterBtn.appendChild(badge);
        }

        if (
          currentStatusFilter.includes("all") ||
          currentStatusFilter.length === 6
        ) {
          // Show all statuses selected
          badge.textContent = "";
          filterContainer.classList.remove("active");
        } else {
          // Show count of selected statuses
          badge.textContent = currentStatusFilter.length;
          filterContainer.classList.add("active");
        }
      }

      // Filter orders by selected statuses
      function filterOrdersByStatus() {
        if (
          currentStatusFilter.includes("all") ||
          currentStatusFilter.length === 0
        ) {
          // Show all orders
          renderOrdersTable(allOrders);
          return;
        }

        const filteredOrders = allOrders.filter((order) => {
          // Handle different status formats
          const orderStatus = order.status?.toLowerCase() || "";

          // Map "ordered" to "confirmed" for filtering if needed
          if (
            orderStatus === "ordered" &&
            currentStatusFilter.includes("confirmed")
          ) {
            return true;
          }

          // Map "awaiting_payment" to "ordered" if needed
          if (
            orderStatus === "awaiting_payment" &&
            currentStatusFilter.includes("awaiting_payment")
          ) {
            return true;
          }

          return currentStatusFilter.includes(orderStatus);
        });

        renderOrdersTable(filteredOrders);
      }

      // Modify the existing search functionality to work with status filter
      const originalSearch =
        document.getElementById("searchOrders").addEventListener;
      document
        .getElementById("searchOrders")
        .addEventListener("input", function (e) {
          const searchTerm = e.target.value.toLowerCase();

          // First filter by status
          let filteredOrders = allOrders;
          if (
            !currentStatusFilter.includes("all") &&
            currentStatusFilter.length > 0
          ) {
            filteredOrders = allOrders.filter((order) => {
              const orderStatus = order.status?.toLowerCase() || "";
              if (
                orderStatus === "ordered" &&
                currentStatusFilter.includes("confirmed")
              ) {
                return true;
              }
              return currentStatusFilter.includes(orderStatus);
            });
          }

          // Then filter by search term
          const searchFiltered = filteredOrders.filter(
            (order) =>
              (order.orderId &&
                order.orderId.toLowerCase().includes(searchTerm)) ||
              (order.customerName &&
                order.customerName.toLowerCase().includes(searchTerm)) ||
              (order.customerPhone &&
                order.customerPhone.includes(searchTerm)) ||
              (order.customerEmail &&
                order.customerEmail.toLowerCase().includes(searchTerm)) ||
              (order.userType &&
                order.userType.toLowerCase().includes(searchTerm))
          );

          renderOrdersTable(searchFiltered);
        });
      function showNoOrders() {
        const tbody = document.getElementById("ordersTable");
        tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px;">
                        <i class="fas fa-box-open" style="font-size: 48px; color: #ddd; margin-bottom: 20px; display: block;"></i>
                        <p>No orders found</p>
                        <button onclick="loadOrders()" class="btn btn-primary" style="margin-top: 10px;">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </td>
                </tr>
            `;

        // Reset stats
        document.getElementById("totalOrders").textContent = "0";
        document.getElementById("pendingOrders").textContent = "0";
        document.getElementById("completedOrders").textContent = "0";
        document.getElementById("totalRevenue").textContent = "₦0";
      }

      // Update statistics
      function updateStats() {
        const totalOrders = allOrders.length;
        const pendingOrders = allOrders.filter(
          (order) =>
            order.status === "awaiting_payment" || order.status === "ordered"
        ).length;
        const completedOrders = allOrders.filter(
          (order) => order.status === "delivered"
        ).length;
        const totalRevenue = allOrders.reduce(
          (sum, order) => sum + (parseFloat(order.totalAmount) || 0),
          0
        );

        document.getElementById("totalOrders").textContent = totalOrders;
        document.getElementById("pendingOrders").textContent = pendingOrders;
        document.getElementById("completedOrders").textContent =
          completedOrders;
        document.getElementById("totalRevenue").textContent =
          formatCurrency(totalRevenue);
      }

      // Update Today's Overview metrics
      function updateTodaysOverview() {
        if (allOrders.length === 0) {
          // Reset metrics if no orders
          document.getElementById("todayOrders").textContent = "0";
          document.getElementById("todayRevenue").textContent = "₦0";
          document.getElementById("avgOrderValue").textContent = "₦0";
          document.getElementById("completionRate").textContent = "0%";
          return;
        }

        // Get today's date (midnight to now)
        const today = new Date();
        const todayStart = new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate()
        );

        // Filter today's orders
        const todaysOrders = allOrders.filter((order) => {
          const orderDate = new Date(order.createdAt || order.orderDate);
          return orderDate >= todayStart;
        });

        // Calculate today's metrics
        const todayOrdersCount = todaysOrders.length;
        const todayRevenue = todaysOrders.reduce(
          (sum, order) => sum + (parseFloat(order.totalAmount) || 0),
          0
        );

        // Calculate average order value (all orders)
        const totalRevenue = allOrders.reduce(
          (sum, order) => sum + (parseFloat(order.totalAmount) || 0),
          0
        );
        const avgOrderValue =
          allOrders.length > 0 ? totalRevenue / allOrders.length : 0;

        // Calculate completion rate (delivered orders vs total)
        const completedOrders = allOrders.filter(
          (order) => order.status === "delivered"
        ).length;
        const completionRate =
          allOrders.length > 0
            ? Math.round((completedOrders / allOrders.length) * 100)
            : 0;

        // Update DOM elements
        document.getElementById("todayOrders").textContent = todayOrdersCount;
        document.getElementById("todayRevenue").textContent =
          formatCurrency(todayRevenue);
        document.getElementById("avgOrderValue").textContent =
          formatCurrency(avgOrderValue);
        document.getElementById(
          "completionRate"
        ).textContent = `${completionRate}%`;
      }

      // Render orders table
      function renderOrdersTable(orders) {
        const tbody = document.getElementById("ordersTable");
        tbody.innerHTML = "";

        if (orders.length === 0) {
          showNoOrders();
          return;
        }

        orders.forEach((order) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>
                        ${order.orderId || "N/A"}
                        ${
                          order.userType === "unregistered"
                            ? '<br><small style="color: #666; font-size: 11px;"><i class="fas fa-user-clock"></i> Unregistered User</small>'
                            : order.userType === "registered"
                            ? '<br><small style="color: #2196f3; font-size: 11px;"><i class="fas fa-user-check"></i> Registered User</small>'
                            : '<br><small style="color: #999; font-size: 11px;"><i class="fas fa-save"></i> Local Storage</small>'
                        }
                    </td>
                    <td>
                        <strong>${order.customerName || "N/A"}</strong><br>
                        <small>${order.customerPhone || "N/A"}</small>
                        ${
                          order.customerEmail
                            ? "<br><small>" + order.customerEmail + "</small>"
                            : ""
                        }
                    </td>
                    <td>${formatDate(order.createdAt || order.orderDate)}</td>
                    <td>${formatCurrency(order.totalAmount)}</td>
                    <td>${getStatusBadge(order.status)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" onclick="viewOrder('${
                              order.orderId
                            }', '${order.firebaseId || order.orderId}', '${
            order.firebaseCollection || "orders"
          }', '${order.userType || "unknown"}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit-btn" onclick="editOrder('${
                              order.orderId
                            }', '${order.firebaseId || order.orderId}', '${
            order.firebaseCollection || "orders"
          }', '${order.userType || "unknown"}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="showDeleteModal('${
                              order.orderId
                            }', '${order.firebaseId || order.orderId}', '${
            order.firebaseCollection || "orders"
          }', '${order.userType || "unknown"}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // Find order in any collection
      async function findOrder(orderId, collectionType = "orders") {
        try {
          if (collectionType === "localStorage") {
            // Search in localStorage
            const userOrders = JSON.parse(
              localStorage.getItem("userOrders") || "{}"
            );
            for (const userId in userOrders) {
              const found = userOrders[userId].find(
                (order) => order.orderId === orderId
              );
              if (found) {
                return {
                  orderData: found,
                  firebaseDocId: orderId,
                  collection: "localStorage",
                };
              }
            }

            // Search in unregistered localStorage
            const unregisteredOrders = JSON.parse(
              localStorage.getItem("unregisteredOrders") || "[]"
            );
            const unregisteredFound = unregisteredOrders.find(
              (order) => order.orderId === orderId
            );
            if (unregisteredFound) {
              return {
                orderData: unregisteredFound,
                firebaseDocId: orderId,
                collection: "localStorage",
              };
            }

            return null;
          }

          // Search in Firebase
          const orderRef = doc(db, collectionType, orderId);
          const orderDoc = await getDoc(orderRef);

          if (orderDoc.exists()) {
            return {
              orderData: orderDoc.data(),
              firebaseDocId: orderId,
              collection: collectionType,
            };
          }

          // If not found in specified collection, try searching in other collections
          if (collectionType === "orders") {
            const unregisteredRef = doc(db, "unregisteredOrders", orderId);
            const unregisteredDoc = await getDoc(unregisteredRef);
            if (unregisteredDoc.exists()) {
              return {
                orderData: unregisteredDoc.data(),
                firebaseDocId: orderId,
                collection: "unregisteredOrders",
              };
            }
          } else if (collectionType === "unregisteredOrders") {
            const registeredRef = doc(db, "orders", orderId);
            const registeredDoc = await getDoc(registeredRef);
            if (registeredDoc.exists()) {
              return {
                orderData: registeredDoc.data(),
                firebaseDocId: orderId,
                collection: "orders",
              };
            }
          }

          return null;
        } catch (error) {
          console.error("Error finding order:", error);
          return null;
        }
      }

      // View order details
      async function viewOrder(
        orderId,
        firebaseId = null,
        collectionType = "orders",
        userType = "unknown"
      ) {
        try {
          let orderResult = null;

          // Try to find the order
          if (firebaseId && collectionType !== "localStorage") {
            orderResult = await findOrder(orderId, collectionType);
          } else {
            // Try all possible locations
            orderResult =
              (await findOrder(orderId, "orders")) ||
              (await findOrder(orderId, "unregisteredOrders")) ||
              (await findOrder(orderId, "localStorage"));
          }

          if (!orderResult || !orderResult.orderData) {
            alert("Order not found");
            return;
          }

          const orderData = orderResult.orderData;
          const actualFirebaseId = orderResult.firebaseDocId;
          const actualCollection = orderResult.collection;

          // Generate order items HTML
          const orderItemsHTML =
            orderData.items && orderData.items.length > 0
              ? orderData.items
                  .map((item, index) => {
                    const productName =
                      item.productName || item.name || "Product";
                    const imgUrl =
                      item.image || item.img || "product-placeholder.jpg";
                    const price = item.price || 0;
                    const quantity = item.quantity || 1;
                    const subtotal = item.subtotal || price * quantity;
                    const productId = item.productId || `ITEM-${index + 1}`;

                    return `
                            <div class="order-item-card">
                                <img src="${imgUrl}" alt="${productName}" class="order-item-img" 
                                     onerror="this.src='product-placeholder.jpg'">
                                <div class="order-item-info">
                                    <h4>${productName}</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                                        <div>
                                            <p style="font-size: 13px; color: #666; margin: 3px 0;">
                                                <strong>Quantity:</strong> ${quantity}
                                            </p>
                                            <p style="font-size: 13px; color: #666; margin: 3px 0;">
                                                <strong>Price:</strong> ${formatCurrency(
                                                  price
                                                )} each
                                            </p>
                                        </div>
                                        <div>
                                            <p style="font-size: 13px; color: #666; margin: 3px 0;">
                                                <strong>Product ID:</strong> ${productId}
                                            </p>
                                            <p style="font-size: 13px; color: #666; margin: 3px 0;">
                                                <strong>Subtotal:</strong> ${formatCurrency(
                                                  subtotal
                                                )}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                  })
                  .join("")
              : "<p>No items in this order</p>";

          // Calculate total items
          const totalItems = orderData.items
            ? orderData.items.reduce(
                (sum, item) => sum + (item.quantity || 1),
                0
              )
            : 0;

          // User type indicator
          const userTypeIndicator =
            userType === "unregistered"
              ? '<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px;">Unregistered User</span>'
              : userType === "registered"
              ? '<span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px;">Registered User</span>'
              : "";

          // Modal content
          const modalBody = document.getElementById("modalBody");
          modalBody.innerHTML = `
                    <div style="display: grid; gap: 20px;">
                        <!-- Order Header -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label>Order ID ${userTypeIndicator}</label>
                                <input type="text" value="${
                                  orderData.orderId || orderId
                                }" readonly>
                                <small style="color: #666;">Source: ${actualCollection}</small>
                            </div>
                            <div class="form-group">
                                <label>Current Status</label>
                                <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">
                                    ${getStatusBadge(orderData.status)}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer Info -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label>Customer Name</label>
                                <input type="text" value="${
                                  orderData.customerName || "N/A"
                                }" readonly>
                            </div>
                            <div class="form-group">
                                <label>Customer Phone</label>
                                <input type="text" value="${
                                  orderData.customerPhone || "N/A"
                                }" readonly>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label>Customer Email</label>
                                <input type="text" value="${
                                  orderData.customerEmail || "N/A"
                                }" readonly>
                            </div>
                            <div class="form-group">
                                <label>Order Date</label>
                                <input type="text" value="${formatDate(
                                  orderData.createdAt || orderData.orderDate
                                )}" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Delivery Address</label>
                            <textarea readonly style="min-height: 60px;">${
                              orderData.customerAddress || "N/A"
                            }</textarea>
                        </div>
                        
                        <!-- Order Summary -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label>Total Amount</label>
                                <input type="text" value="${formatCurrency(
                                  orderData.totalAmount
                                )}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <input type="text" value="${
                                  orderData.paymentMethod || "Bank Transfer"
                                }" readonly>
                            </div>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="form-group">
                            <label>
                                Order Items (${totalItems} item${
            totalItems !== 1 ? "s" : ""
          })
                            </label>
                            <div class="order-items-grid">
                                ${orderItemsHTML}
                            </div>
                        </div>
                        
                        <!-- Payment Proof -->
                        ${
                          orderData.paymentProofUrl
                            ? `
                        <div class="form-group">
                            <label>Payment Proof</label>
                            <div style="margin-top: 10px;">
                                <a href="${
                                  orderData.paymentProofUrl
                                }" target="_blank" 
                                   style="color: var(--primary-color); text-decoration: none; display: inline-flex; align-items: center; gap: 5px; margin-right: 15px;">
                                    <i class="fas fa-external-link-alt"></i> View Payment Proof
                                </a>
                            </div>
                            ${
                              orderData.paymentProofUrl.startsWith("http") ||
                              orderData.paymentProofUrl.startsWith("data:image")
                                ? `<img src="${orderData.paymentProofUrl}" alt="Payment Proof" 
                                     style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd; margin-top: 10px;" 
                                     onerror="this.style.display='none'">`
                                : ""
                            }
                        </div>
                        `
                            : '<div class="form-group"><label>Payment Proof:</label><p>No payment proof uploaded</p></div>'
                        }
                        
                        <!-- Admin Notes -->
                        <div class="form-group">
                            <label>Admin Notes</label>
                            <textarea id="adminNotes" placeholder="Add notes about this order...">${
                              orderData.adminNotes || ""
                            }</textarea>
                        </div>
                        
                        <!-- Status Actions -->
                        <div class="form-group">
                            <label>Update Order Status</label>
                            <div class="status-actions">
                                <button class="status-btn confirmed" onclick="updateOrderStatus('${orderId}', '${
            actualFirebaseId || orderId
          }', 'confirmed', '${actualCollection}')"
                                        ${
                                          orderData.status === "confirmed"
                                            ? 'disabled style="opacity: 0.5; cursor: not-allowed;"'
                                            : ""
                                        }>
                                    <i class="fas fa-check-circle"></i> 
                                    ${
                                      orderData.status === "confirmed"
                                        ? "Already Confirmed"
                                        : "Mark as Confirmed"
                                    }
                                </button>
                                <button class="status-btn processing" onclick="updateOrderStatus('${orderId}', '${
            actualFirebaseId || orderId
          }', 'processing', '${actualCollection}')"
                                        ${
                                          orderData.status === "processing"
                                            ? 'disabled style="opacity: 0.5; cursor: not-allowed;"'
                                            : ""
                                        }>
                                    <i class="fas fa-cog"></i> 
                                    ${
                                      orderData.status === "processing"
                                        ? "Processing"
                                        : "Mark as Processing"
                                    }
                                </button>
                                <button class="status-btn shipped" onclick="updateOrderStatus('${orderId}', '${
            actualFirebaseId || orderId
          }', 'shipped', '${actualCollection}')"
                                        ${
                                          orderData.status === "shipped"
                                            ? 'disabled style="opacity: 0.5; cursor: not-allowed;"'
                                            : ""
                                        }>
                                    <i class="fas fa-truck"></i> 
                                    ${
                                      orderData.status === "shipped"
                                        ? "Already Shipped"
                                        : "Mark as Shipped"
                                    }
                                </button>
                                <button class="status-btn delivered" onclick="updateOrderStatus('${orderId}', '${
            actualFirebaseId || orderId
          }', 'delivered', '${actualCollection}')"
                                        ${
                                          orderData.status === "delivered"
                                            ? 'disabled style="opacity: 0.5; cursor: not-allowed;"'
                                            : ""
                                        }>
                                    <i class="fas fa-check"></i> 
                                    ${
                                      orderData.status === "delivered"
                                        ? "Already Delivered"
                                        : "Mark as Delivered"
                                    }
                                </button>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="saveAdminNotes('${orderId}', '${
            actualFirebaseId || orderId
          }', '${actualCollection}')">
                                <i class="fas fa-save"></i> Save Notes
                            </button>
                            <button class="btn btn-primary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                `;

          document.getElementById("orderModal").style.display = "flex";
        } catch (error) {
          console.error("Error viewing order:", error);
          alert("Error loading order details");
        }
      }

      // Update order status
      async function updateOrderStatus(orderId, firebaseId, status, collectionType = "orders") {
  const statusText = {
    awaiting_payment: "Awaiting Payment",
    ordered: "Ordered",
    confirmed: "Confirmed",
    processing: "Processing",
    shipped: "Shipped",
    delivered: "Delivered",
    cancelled: "Cancelled",
  }[status] || status;

  if (!confirm(`Change order #${orderId} status to "${statusText}"?`)) return;

  try {
    const updateData = {
      status: status,
      updatedAt: new Date().toISOString(),
      lastStatusUpdate: new Date().toISOString(),
      statusUpdatedBy: "admin",
    };

    if (status === "shipped") {
      updateData.trackingNumber = "TRK-" + Date.now().toString().slice(-8);
      updateData.shippedAt = new Date().toISOString();
    }

    if (status === "delivered") {
      updateData.deliveryDate = new Date().toISOString();
      updateData.deliveredAt = new Date().toISOString();
    }

    // 1. UPDATE IN FIREBASE (PRIMARY SOURCE)
    let firebaseUpdated = false;
    if (firebaseId && collectionType !== "localStorage") {
      try {
        // Update in the specific collection
        const orderRef = doc(db, collectionType, firebaseId);
        await updateDoc(orderRef, updateData);
        firebaseUpdated = true;
        console.log(`✅ Updated order in ${collectionType}`);

        // Try to update in the other collection for consistency
        const otherCollection = collectionType === "orders" ? "unregisteredOrders" : "orders";
        try {
          const otherRef = doc(db, otherCollection, orderId);
          await updateDoc(otherRef, updateData);
          console.log(`✅ Also updated in ${otherCollection}`);
        } catch (otherError) {
          console.log(`Order not found in ${otherCollection}`);
        }
      } catch (firebaseError) {
        console.error("Firebase update error:", firebaseError);
      }
    }

    // 2. UPDATE IN LOCALSTORAGE FOR ALL USERS
    try {
      // Update in registered users localStorage
      const allUserOrders = JSON.parse(localStorage.getItem("allUserOrders") || "{}");
      let localStorageUpdated = false;

      for (const userId in allUserOrders) {
        const orderIndex = allUserOrders[userId].findIndex(
          (order) => order.orderId === orderId
        );
        if (orderIndex !== -1) {
          allUserOrders[userId][orderIndex] = {
            ...allUserOrders[userId][orderIndex],
            ...updateData
          };
          localStorageUpdated = true;
        }
      }

      if (localStorageUpdated) {
        localStorage.setItem("allUserOrders", JSON.stringify(allUserOrders));
        console.log("✅ Updated in localStorage (all users)");
      }

      // Update in unregistered localStorage
      const unregisteredOrders = JSON.parse(
        localStorage.getItem("unregisteredOrders") || "[]"
      );
      const unregisteredIndex = unregisteredOrders.findIndex(
        (order) => order.orderId === orderId
      );
      if (unregisteredIndex !== -1) {
        unregisteredOrders[unregisteredIndex] = {
          ...unregisteredOrders[unregisteredIndex],
          ...updateData
        };
        localStorage.setItem(
          "unregisteredOrders",
          JSON.stringify(unregisteredOrders)
        );
        console.log("✅ Updated in localStorage (unregistered)");
      }
    } catch (localStorageError) {
      console.error("LocalStorage update error:", localStorageError);
    }

    // 3. UPDATE IN THE CURRENT ORDERS LIST
    const orderIndex = allOrders.findIndex(
      (order) => order.orderId === orderId
    );
    if (orderIndex !== -1) {
      allOrders[orderIndex] = {
        ...allOrders[orderIndex],
        ...updateData
      };
    }

    // 4. UPDATE UI
    if (firebaseUpdated) {
      alert(`✅ Order #${orderId} status updated to "${statusText}" successfully!`);
      closeModal();
      
      // Refresh orders from Firebase to get latest status
      await loadOrders().then(() => {
        filterOrdersByStatus();
        updateTodaysOverview();
      });
    } else {
      // Fallback: Just update UI
      alert(`⚠️ Status updated locally. Firebase update may have failed.`);
      updateStats();
      renderOrdersTable(allOrders);
      filterOrdersByStatus();
      updateTodaysOverview();
      closeModal();
    }

  } catch (error) {
    console.error("Error updating order:", error);
    alert("Error updating order status");
  }
}
      // Save admin notes
      async function saveAdminNotes(
        orderId,
        firebaseId,
        collectionType = "orders"
      ) {
        const notes = document.getElementById("adminNotes").value;

        try {
          let success = false;

          // Save to Firebase if not localStorage
          if (collectionType !== "localStorage" && firebaseId) {
            try {
              const orderRef = doc(db, collectionType, firebaseId);
              await updateDoc(orderRef, {
                adminNotes: notes,
                updatedAt: new Date().toISOString(),
              });
              success = true;
            } catch (firebaseError) {
              console.error("Firebase notes save failed:", firebaseError);
            }
          }

          // Save to localStorage
          try {
            // Save to registered localStorage
            const userOrders = JSON.parse(
              localStorage.getItem("userOrders") || "{}"
            );
            let localStorageSaved = false;

            for (const userId in userOrders) {
              const orderIndex = userOrders[userId].findIndex(
                (order) => order.orderId === orderId
              );
              if (orderIndex !== -1) {
                userOrders[userId][orderIndex].adminNotes = notes;
                userOrders[userId][orderIndex].updatedAt =
                  new Date().toISOString();
                localStorageSaved = true;
                break;
              }
            }

            if (localStorageSaved) {
              localStorage.setItem("userOrders", JSON.stringify(userOrders));
            }

            // Save to unregistered localStorage
            const unregisteredOrders = JSON.parse(
              localStorage.getItem("unregisteredOrders") || "[]"
            );
            const unregisteredIndex = unregisteredOrders.findIndex(
              (order) => order.orderId === orderId
            );
            if (unregisteredIndex !== -1) {
              unregisteredOrders[unregisteredIndex].adminNotes = notes;
              unregisteredOrders[unregisteredIndex].updatedAt =
                new Date().toISOString();
              localStorage.setItem(
                "unregisteredOrders",
                JSON.stringify(unregisteredOrders)
              );
            }

            success = true;
          } catch (localStorageError) {
            console.error("LocalStorage notes save failed:", localStorageError);
          }

          if (success) {
            alert("✅ Notes saved successfully!");
          } else {
            alert("❌ Failed to save notes");
          }
        } catch (error) {
          console.error("Error saving notes:", error);
          alert("Error saving notes");
        }
      }

      // Edit order
      function editOrder(
        orderId,
        firebaseId = null,
        collectionType = "orders",
        userType = "unknown"
      ) {
        viewOrder(orderId, firebaseId, collectionType, userType);
      }

      // Close modal
      function closeModal() {
        document.getElementById("orderModal").style.display = "none";
      }

      // Refresh orders
      function refreshOrders() {
        loadOrders();
      }

      // Export orders
      function exportOrders() {
        const csv = convertToCSV(allOrders);
        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `orders_${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
      }

      // Convert to CSV
      function convertToCSV(orders) {
        const headers = [
          "Order ID",
          "User Type",
          "Customer Name",
          "Phone",
          "Email",
          "Address",
          "Status",
          "Amount",
          "Date",
          "Items Count",
          "Collection",
        ];
        const rows = orders.map((order) => [
          order.orderId || "",
          order.userType || "unknown",
          order.customerName || "",
          order.customerPhone || "",
          order.customerEmail || "",
          order.customerAddress || "",
          order.status || "",
          order.totalAmount || 0,
          order.createdAt || order.orderDate || "",
          order.items ? order.items.length : 0,
          order.firebaseCollection || "",
        ]);

        return [headers, ...rows]
          .map((row) =>
            row.map((cell) => `"${String(cell).replace(/"/g, '""')}"`).join(",")
          )
          .join("\n");
      }

      // Update charts
      function updateCharts() {
        // Sales chart
        const salesCtx = document.getElementById("salesChart");
        if (!salesCtx) return;

        if (window.salesChart) {
          window.salesChart.destroy();
        }

        // Group orders by date
        const salesByDate = {};
        allOrders.forEach((order) => {
          const date = new Date(
            order.createdAt || order.orderDate
          ).toLocaleDateString("en-US", { month: "short", day: "numeric" });
          if (!salesByDate[date]) {
            salesByDate[date] = 0;
          }
          salesByDate[date] += parseFloat(order.totalAmount) || 0;
        });

        const dates = Object.keys(salesByDate).slice(-7);
        const sales = dates.map((date) => salesByDate[date]);

        window.salesChart = new Chart(salesCtx, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              {
                label: "Sales",
                data: sales,
                borderColor: "rgb(75, 192, 192)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });

        // Status chart
        const statusCtx = document.getElementById("statusChart");
        if (!statusCtx) return;

        if (window.statusChart) {
          window.statusChart.destroy();
        }

        const statusCounts = {
          awaiting_payment: allOrders.filter(
            (o) => o.status === "awaiting_payment"
          ).length,
          ordered: allOrders.filter((o) => o.status === "ordered").length,
          confirmed: allOrders.filter((o) => o.status === "confirmed").length,
          processing: allOrders.filter((o) => o.status === "processing").length,
          shipped: allOrders.filter((o) => o.status === "shipped").length,
          delivered: allOrders.filter((o) => o.status === "delivered").length,
          cancelled: allOrders.filter((o) => o.status === "cancelled").length,
        };

        window.statusChart = new Chart(statusCtx, {
          type: "doughnut",
          data: {
            labels: [
              "Awaiting Payment",
              "Ordered",
              "Confirmed",
              "Processing",
              "Shipped",
              "Delivered",
              "Cancelled",
            ],
            datasets: [
              {
                data: [
                  statusCounts.awaiting_payment,
                  statusCounts.ordered,
                  statusCounts.confirmed,
                  statusCounts.processing,
                  statusCounts.shipped,
                  statusCounts.delivered,
                  statusCounts.cancelled,
                ],
                backgroundColor: [
                  "#fff3cd", // Awaiting Payment
                  "#ffe0b2", // Ordered
                  "#d1ecf1", // Confirmed
                  "#cce5ff", // Processing
                  "#d4edda", // Shipped
                  "#28a745", // Delivered
                  "#f8d7da", // Cancelled
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      // DELETE ORDER FUNCTION
      async function deleteOrder(
        orderId,
        firebaseId = null,
        collectionType = "orders",
        userType = "unknown"
      ) {
        try {
          let success = false;
          let deletedFrom = [];

          // Delete from Firebase if applicable
          if (collectionType !== "localStorage" && firebaseId) {
            try {
              const orderRef = doc(db, collectionType, firebaseId);
              await deleteDoc(orderRef);
              deletedFrom.push(`Firebase (${collectionType})`);
              success = true;
              console.log(`✅ Deleted order from ${collectionType}`);
            } catch (firebaseError) {
              console.error("Firebase delete error:", firebaseError);
            }
          }

          // Delete from localStorage for registered users
          try {
            const userOrders = JSON.parse(
              localStorage.getItem("userOrders") || "{}"
            );
            let localStorageDeleted = false;

            for (const userId in userOrders) {
              const orderIndex = userOrders[userId].findIndex(
                (order) => order.orderId === orderId
              );
              if (orderIndex !== -1) {
                userOrders[userId].splice(orderIndex, 1);

                // Remove user entry if no orders left
                if (userOrders[userId].length === 0) {
                  delete userOrders[userId];
                }

                localStorage.setItem("userOrders", JSON.stringify(userOrders));
                deletedFrom.push("Local Storage (registered)");
                localStorageDeleted = true;
                success = true;
                break;
              }
            }

            // Delete from unregistered localStorage
            const unregisteredOrders = JSON.parse(
              localStorage.getItem("unregisteredOrders") || "[]"
            );
            const unregisteredIndex = unregisteredOrders.findIndex(
              (order) => order.orderId === orderId
            );

            if (unregisteredIndex !== -1) {
              unregisteredOrders.splice(unregisteredIndex, 1);
              localStorage.setItem(
                "unregisteredOrders",
                JSON.stringify(unregisteredOrders)
              );

              if (!localStorageDeleted) {
                deletedFrom.push("Local Storage (unregistered)");
              } else {
                deletedFrom[deletedFrom.length - 1] = "Local Storage (both)";
              }
              success = true;
            }
          } catch (localStorageError) {
            console.error("LocalStorage delete error:", localStorageError);
          }

          // Also try to delete from other collections for cleanup
          if (collectionType === "orders") {
            try {
              const unregisteredRef = doc(db, "unregisteredOrders", orderId);
              await deleteDoc(unregisteredRef);
              deletedFrom.push("Firebase (unregisteredOrders)");
              console.log("✅ Also deleted from unregisteredOrders");
            } catch (e) {
              console.log("No matching unregistered order to delete");
            }
          } else if (collectionType === "unregisteredOrders") {
            try {
              const registeredRef = doc(db, "orders", orderId);
              await deleteDoc(registeredRef);
              deletedFrom.push("Firebase (orders)");
              console.log("✅ Also deleted from orders");
            } catch (e) {
              console.log("No matching registered order to delete");
            }
          }

          if (success) {
            // Remove from current allOrders array
            const orderIndex = allOrders.findIndex(
              (order) => order.orderId === orderId
            );
            if (orderIndex !== -1) {
              allOrders.splice(orderIndex, 1);
            }

            // Update UI
            // Update UI
            updateStats();
            renderOrdersTable(allOrders);
            updateCharts();
            updateTodaysOverview(); // Add this line

            // Show success message
            let message = `✅ Order #${orderId} deleted successfully!`;
            if (deletedFrom.length > 0) {
              message += `\nDeleted from: ${deletedFrom.join(", ")}`;
            }
            alert(message);
          } else {
            alert(
              `❌ Could not delete order #${orderId}. It may have already been deleted or you don't have permission.`
            );
          }
        } catch (error) {
          console.error("Error deleting order:", error);
          alert("Error deleting order. Please try again.");
        }
      }

      // DELETE MODAL FUNCTIONS
      function showDeleteModal(orderId, firebaseId, collectionType, userType) {
        pendingDeleteOrder = { orderId, firebaseId, collectionType, userType };

        const modalBody = document.getElementById("deleteModalBody");
        modalBody.innerHTML = `
                <div style="padding: 20px 0;">
                    <p style="margin-bottom: 20px; font-size: 16px;">
                        Are you sure you want to delete <strong>Order #${orderId}</strong>?
                    </p>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">
                            <i class="fas fa-exclamation-circle"></i> Warning
                        </h4>
                        <p style="margin: 0; color: #856404; font-size: 14px;">
                            This action cannot be undone. All order data including customer information, 
                            items, and payment details will be permanently deleted.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn" onclick="confirmDelete()" 
                                style="flex: 1; background: #f44336; color: white;">
                            <i class="fas fa-trash"></i> Delete Order
                        </button>
                    </div>
                </div>
            `;

        document.getElementById("deleteModal").style.display = "flex";
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").style.display = "none";
        pendingDeleteOrder = null;
      }

      async function confirmDelete() {
        if (pendingDeleteOrder) {
          const { orderId, firebaseId, collectionType, userType } =
            pendingDeleteOrder;
          closeDeleteModal();
          await deleteOrder(orderId, firebaseId, collectionType, userType);
        }
      }

      // Search functionality
      document
        .getElementById("searchOrders")
        .addEventListener("input", function (e) {
          const searchTerm = e.target.value.toLowerCase();
          const filteredOrders = allOrders.filter(
            (order) =>
              (order.orderId &&
                order.orderId.toLowerCase().includes(searchTerm)) ||
              (order.customerName &&
                order.customerName.toLowerCase().includes(searchTerm)) ||
              (order.customerPhone &&
                order.customerPhone.includes(searchTerm)) ||
              (order.customerEmail &&
                order.customerEmail.toLowerCase().includes(searchTerm)) ||
              (order.userType &&
                order.userType.toLowerCase().includes(searchTerm))
          );
          renderOrdersTable(filteredOrders);
        });

      // EXPOSE FUNCTIONS TO GLOBAL SCOPE
      window.viewOrder = viewOrder;
      window.editOrder = editOrder;
      window.updateOrderStatus = updateOrderStatus;
      window.saveAdminNotes = saveAdminNotes;
      window.closeModal = closeModal;
      window.refreshOrders = refreshOrders;
      window.exportOrders = exportOrders;
      window.loadOrders = loadOrders;
      window.showDeleteModal = showDeleteModal;
      window.closeDeleteModal = closeDeleteModal;
      window.confirmDelete = confirmDelete;
      window.deleteOrder = deleteOrder;

      window.applyStatusFilter = applyStatusFilter;
      window.resetStatusFilter = resetStatusFilter;
      window.filterOrdersByStatus = filterOrdersByStatus;
      window.updateTodaysOverview = updateTodaysOverview;
    </script>
  </body>
</html>
